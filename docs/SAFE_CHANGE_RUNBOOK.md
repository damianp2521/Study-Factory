# 안전 변경 런북 (100명 운영 기준)

## 목표
- 기존 기능을 한 개도 빠뜨리지 않고 유지한다.
- Supabase 연동 무결성을 유지한다.
- 수정은 작은 단위로 적용하고, 항상 되돌릴 수 있게 한다.

## 1) 변경 전 원칙
- 한 번에 한 가지 목적만 수정한다.
- SQL 변경은 앱 코드 변경과 분리해서 관리한다.
- DB 스키마 변경 전에는 반드시 `IF EXISTS` / `IF NOT EXISTS`를 사용한다.
- 기존 컬럼/테이블 삭제, 의미 변경은 금지하고 추가 방식으로만 진행한다.

## 2) 변경 전 체크
- `npm run build`가 성공해야 한다.
- `npm run lint`가 에러 없이 끝나야 한다.
- 권장: `npm run preflight`로 일괄 점검한다.
- 영향 화면을 지정하고 수동 스모크 테스트 항목을 작성한다.
- Supabase 접속 값 확인:
  - `VITE_SUPABASE_URL`
  - `VITE_SUPABASE_ANON_KEY`

## 3) Supabase 변경 규칙
- SQL 파일은 루트에 새 파일로 추가한다.
- 파일명에 목적과 날짜를 명시한다. 예: `2026-02-14_add_xxx.sql`
- SQL 실행 순서:
  1. 로컬/스테이징에서 실행
  2. 관리자 핵심 화면 점검
  3. 운영 반영
- 운영 반영 후 `node scripts/verify_db.js`로 기본 RPC 접근 확인

## 4) 배포 전 최소 스모크
- 로그인/로그아웃
- 권한 라우팅 (member/staff/admin)
- 회원 휴가 신청/취소
- 출석부 조회/수정
- 건의함 조회/처리
- 관리자 회원등록/회원현황/휴가상세
- 스탭 업무보드/음료 관리
- 상세 항목은 `docs/SMOKE_CHECKLIST.md`를 사용한다.

## 5) 장애 방지 가드
- 새로운 필드는 nullable 또는 기본값 포함으로 추가한다.
- 기존 쿼리 결과 shape를 깨는 rename/drop을 금지한다.
- 컴포넌트 훅 순서를 바꾸는 조건부 early return을 금지한다.
- 저장/삭제 액션은 성공 후 재조회(fetch)로 화면 정합성을 맞춘다.

## 6) 롤백 기준
- 사용자 주요 플로우에서 1개라도 실패하면 즉시 롤백한다.
- 롤백 순서:
  1. 앱 배포 롤백
  2. DB 변경이 원인이면 대응 SQL 실행
  3. 핵심 플로우 재검증

## 7) 이번 프로젝트 즉시 우선순위
- 런타임 오류 먼저 처리 (`no-undef`, 조건부 Hook)
- 중복 네트워크 호출 제거
- Supabase 연결 스크립트 환경변수화
- 이후 대규모 리팩터링은 화면 단위로 분할 진행
